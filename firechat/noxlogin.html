<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Add these meta tags in the head section, right after the existing viewport meta tag -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <title>Modern Login & Signup</title>
    <script>
        // Immediate Auth Check - BEFORE any rendering
        (function () {
            const isLoggedOut = localStorage.getItem('isLoggedOut') === 'true';
            if (!isLoggedOut) {
                const sessionUser = sessionStorage.getItem('currentUser');
                const userId = localStorage.getItem('userId');
                const userName = localStorage.getItem('userName');
                if (sessionUser || userId || userName) {
                    window.location.href = 'chat.html';
                }
            }
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 20px 20px 0 20px;
            margin: 0;
            overflow-x: hidden;
        }

        .container {
            margin: 10px 0 20px 0;
            position: relative;
            width: 100%;
            max-width: 850px;
            background: #fff;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
        }

        .site-branding {
            position: relative;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 150;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 15px 0;
            border-radius: 12px 12px 0 0;
            border-bottom: 2px solid rgba(102, 126, 234, 0.2);
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: 1px;
            margin-bottom: 5px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .fire {
            background: linear-gradient(135deg, #ff8a00, #ff0058);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .fly {
            background: linear-gradient(135deg, #ff0058, #5271ff);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nox {
            background: linear-gradient(135deg, #5271ff, #8a4fff);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .tagline {
            font-size: 1rem;
            color: #444;
            font-style: italic;
            font-weight: 500;
        }

        .forms-container {
            position: relative;
            width: 100%;
            height: 480px;
            display: flex;
        }

        .signin-signup,
        .signup-signin {
            padding-top: 15px;
        }

        .signin-signup {
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0 30px;
            transition: 0.5s;
        }

        .signup-signin {
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0 30px;
            transition: 0.5s;
            opacity: 0;
            z-index: 1;
            pointer-events: none;
        }

        .signup-signin.active {
            opacity: 1;
            z-index: 2;
            pointer-events: all;
            margin-left: 50%;
        }

        .container.active .signin-signup {
            opacity: 0;
            z-index: 1;
        }

        .container.active .signup-signin {
            opacity: 1;
            z-index: 2;
        }

        .panels-container {
            position: absolute;
            top: 0;
            left: 50%;
            width: 50%;
            height: 100%;
            overflow: hidden;
            transition: 0.5s;
            z-index: 100;
        }

        .container.active .panels-container {
            left: 0;
        }

        .panel {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 70px 40px 40px;
            /* Increased top padding */
            text-align: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            transition: 0.5s;
        }

        .left-panel {
            right: 0;
        }

        .right-panel {
            left: 0;
            pointer-events: none;
            opacity: 0;
        }

        .container.active .right-panel {
            pointer-events: all;
            opacity: 1;
        }

        .container.active .left-panel {
            pointer-events: none;
            opacity: 0;
        }

        .panel h2 {
            font-size: 2rem;
            margin-bottom: 15px;
            color: #fff;
        }

        .panel p {
            font-size: 1rem;
            line-height: 1.7;
            margin-bottom: 25px;
            max-width: 300px;
        }

        .form {
            width: 100%;
            max-width: 300px;
        }

        .input-field {
            position: relative;
            width: 100%;
            height: 50px;
            margin: 12px 0;
        }

        .input-field input {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            border-bottom: 2px solid #d9d9d9;
            padding: 0 15px;
            font-size: 0.95rem;
            transition: 0.3s;
            background-color: transparent;
        }

        .input-field input:focus {
            border-bottom-color: #667eea;
            box-shadow: 0 1px 0 0 rgba(102, 126, 234, 0.4);
        }

        .input-field input:focus~label,
        .input-field input:valid~label {
            top: -5px;
            font-size: 0.8rem;
            color: #667eea;
        }

        .input-field label {
            position: absolute;
            left: 15px;
            top: 15px;
            font-size: 0.95rem;
            color: #999;
            transition: 0.3s;
            pointer-events: none;
        }

        .btn {
            width: 150px;
            height: 45px;
            border: none;
            outline: none;
            border-radius: 25px;
            border: 2px solid white;
            cursor: pointer;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: #fff;
            font-weight: 600;
            margin: 20px 0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .btn:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #764ba2, #667eea);
            z-index: -2;
        }

        .btn:before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0%;
            height: 100%;
            background: linear-gradient(45deg, #ff8a00, #e52e71);
            transition: all 0.3s;
            z-index: -1;
        }

        .btn:hover:before {
            width: 100%;
        }

        .panel .btn {
            background: #fff;
            color: white;
            font-weight: 600;
        }

        .socials {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .social-icon {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: 0.3s;
        }

        .social-icon:hover {
            background: #f0f0f0;
        }

        .feedback-message {
            color: #d32f2f;
            margin-top: 10px;
            font-size: 0.85rem;
            text-align: center;
        }

        .success-message {
            color: #388e3c;
            margin-top: 10px;
            font-size: 0.85rem;
            text-align: center;
        }

        .loading {
            display: none;
            width: 25px;
            height: 25px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px 10px 0 10px;
            }

            .container {
                margin: 5px 0 15px 0;
                height: auto;
                overflow: visible;
            }

            .site-branding {
                padding: 10px 0;
            }

            .logo {
                font-size: 2rem;
            }

            .tagline {
                font-size: 0.85rem;
            }

            .forms-container {
                min-height: auto;
                height: auto;
                display: block;
                padding-bottom: 20px;
            }

            .signin-signup,
            .signup-signin {
                position: relative;
                top: auto;
                left: auto;
                width: 100%;
                padding: 20px 20px 30px;
                opacity: 1;
                pointer-events: all;
                height: auto;
                transform: none;
                margin-left: 0 !important;
                /* Force override any margin */
            }

            .signup-signin.active {
                margin-left: 0 !important;
                /* Force override */
            }

            .container.active .signup-signin {
                position: relative;
                opacity: 1;
                z-index: 5;
                pointer-events: all;
                transform: none;
                margin-left: 0 !important;
            }

            .signin-signup {
                display: block;
            }

            .signup-signin {
                display: none;
            }

            .container.active .signin-signup {
                display: none;
            }

            .container.active .signup-signin {
                display: block;
            }

            .panels-container {
                display: none;
            }

            .form {
                width: 100%;
                max-width: 100%;
            }

            .input-field {
                margin: 15px 0;
            }

            .btn {
                width: 100%;
                margin: 15px 0;
            }

            .mobile-nav {
                display: block;
                text-align: center;
                margin-top: 20px;
            }

            .mobile-link {
                color: #667eea;
                text-decoration: none;
                cursor: pointer;
                font-weight: 600;
            }

            .mobile-link:hover {
                text-decoration: underline;
            }

            /* Make modals more mobile-friendly */
            .modal {
                width: 95%;
                padding: 20px;
            }

            .modal h3 {
                font-size: 1.2rem;
            }

            .modal-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .modal-btn {
                width: 100%;
                padding: 12px;
            }

            /* Improve footer for mobile */
            .footer {
                margin-top: 10px;
                padding: 15px 0;
                width: 100%;
            }

            .footer-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .footer-links {
                flex-wrap: wrap;
                justify-content: center;
                gap: 15px;
            }

            .footer-social {
                margin: 10px 0;
            }

            .footer-copyright {
                width: 100%;
                margin-top: 10px;
                font-size: 0.75rem;
            }

            /* Adjust account actions for mobile */
            .account-actions {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .remember-me {
                justify-content: center;
            }
        }

        /* Add extra small device optimization */
        @media (max-width: 375px) {
            .logo {
                font-size: 1.7rem;
            }

            .tagline {
                font-size: 0.75rem;
            }

            .form h2 {
                font-size: 1.5rem;
            }

            .input-field {
                height: 45px;
            }

            .input-field input {
                font-size: 0.9rem;
            }

            .input-field label {
                font-size: 0.9rem;
            }

            .footer-links a {
                font-size: 0.8rem;
            }
        }

        /* Extra fix for signup form visibility */
        .container.active .signup-signin {
            opacity: 1;
            z-index: 5;
            pointer-events: all;
        }

        .container.active .signin-signup {
            opacity: 0;
            z-index: 1;
            pointer-events: none;
        }

        /* Update these rules to fix the desktop animation where only the panel should move */
        @media (min-width: 769px) {
            .container {
                position: relative;
                overflow: hidden;
            }

            .signin-signup {
                position: absolute;
                top: 0;
                left: 0;
                width: 50%;
                height: 100%;
                transition: 0.5s ease-in-out;
                opacity: 1;
                z-index: 5;
            }

            .signup-signin {
                position: absolute;
                top: 0;
                left: 0;
                /* Keep the signup form at left: 0 (not 100%) */
                width: 50%;
                height: 100%;
                transition: 0.5s ease-in-out;
                opacity: 0;
                /* Initially hidden */
                z-index: 1;
                pointer-events: none;
            }

            .container.active .signin-signup {
                opacity: 0;
                pointer-events: none;
            }

            .container.active .signup-signin {
                opacity: 1;
                z-index: 5;
                pointer-events: all;
            }

            .panels-container {
                position: absolute;
                top: 0;
                left: 50%;
                width: 50%;
                height: 100%;
                overflow: hidden;
                transition: 0.5s ease-in-out;
                z-index: 100;
            }

            .container.active .panels-container {
                left: 0;
                /* This makes the panel move to the left */
            }

            .panel {
                position: absolute;
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                padding: 70px 40px 40px;
                /* Increased top padding */
                text-align: center;
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: #fff;
                transition: 0.5s;
            }

            .left-panel {
                opacity: 1;
                z-index: 6;
                pointer-events: all;
            }

            .right-panel {
                opacity: 0;
                z-index: 5;
                pointer-events: none;
            }

            .container.active .left-panel {
                opacity: 0;
                pointer-events: none;
            }

            .container.active .right-panel {
                opacity: 1;
                pointer-events: all;
            }
        }

        .remember-me {
            display: flex;
            align-items: center;
            margin-top: 12px;
            width: 100%;
        }

        .remember-checkbox {
            position: relative;
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .remember-me label {
            font-size: 0.9rem;
            color: #666;
            cursor: pointer;
        }

        .account-actions {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 10px;
            font-size: 0.85rem;
        }

        .account-actions a {
            color: #667eea;
            text-decoration: none;
            cursor: pointer;
            transition: 0.3s;
        }

        .account-actions a:hover {
            text-decoration: underline;
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            transform: translateY(0);
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.4rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: 0.3s;
        }

        .modal-btn-primary {
            background-color: #667eea;
            color: white;
        }

        .modal-btn-primary:hover {
            background-color: #5a6fe0;
        }

        .modal-btn-secondary {
            background-color: #f2f2f2;
            color: #333;
        }

        .modal-btn-secondary:hover {
            background-color: #e5e5e5;
        }

        .modal-btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .modal-btn-danger:hover {
            background-color: #c82333;
        }

        .modal .feedback-message {
            margin-top: 15px;
        }

        .modal .success-message {
            margin-top: 15px;
        }

        .modal .loading {
            margin: 15px auto 5px;
        }

        /* Add form transition animation classes */
        .form-exit {
            animation: fadeOutSlide 0.5s forwards;
        }

        .form-enter {
            animation: fadeInSlide 0.5s forwards;
        }

        @keyframes fadeOutSlide {
            0% {
                opacity: 1;
                transform: translateX(0);
            }

            100% {
                opacity: 0;
                transform: translateX(-30px);
            }
        }

        @keyframes fadeInSlide {
            0% {
                opacity: 0;
                transform: translateX(30px);
            }

            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Update footer styles to display in a single line */
        .footer-content {
            margin: 0 auto;
            padding: 0 15px;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }

        .footer-logo {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0;
        }

        .footer-links {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            margin-bottom: 0;
            font-size: 0.9rem;
            color: #fff;
        }

        .footer-links a:hover {
            color: transparent;
            background: linear-gradient(45deg, #ff8a00, #e52e71);
            background-clip: text;
            -webkit-background-clip: text;
            transform: scale(1.1);
            transition: transform 0.3s ease-in-out;
        }

        .footer-social {
            display: flex;
            gap: 10px;
            margin-bottom: 0;
        }

        .footer-social a {
            color: #fff;
            text-decoration: none;
            transition: color 0.3s;
            font-size: 0.9rem;
        }

        .footer-social a:hover {
            background: linear-gradient(45deg, #ff8a00, #e52e71);
            transform: scale(1.1);
            transition: transform 0.3s ease-in-out;
        }


        .footer-copyright {
            font-size: 0.8rem;
            color: #aaa;
        }

        /* Update the footer to attach to the side boundaries */
        .footer {
            width: 100vw;
            margin-left: calc(-50vw + 50%);
            margin-right: calc(-50vw + 50%);
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #fff;
            padding: 4px 0;
            margin-top: 30px;
            border-top: 5px solid #667eea;
            box-sizing: border-box;
            position: relative;
            left: 0;
            right: 0;
        }

        .footer-content {
            margin: 0 auto;
            padding: 0 15px;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
            max-width: 100%;
            width: 100%;
            box-sizing: border-box;
        }

        @media (max-width: 768px) {
            .footer {
                width: 100vw;
                margin-left: calc(-50vw + 50%);
                left: 0;
                right: 0;
            }
        }

        /* Add to your mobile media query */
        @media (max-width: 768px) {

            /* Ensure proper form switching on mobile */
            .container.active .signup-signin {
                display: block !important;
                left: auto !important;
                opacity: 1 !important;
            }

            .container.active .signin-signup {
                display: none !important;
            }
        }

        /* Update footer links color to white */
        .footer-links a {
            color: #dd5050;
            text-decoration: none;
            transition: color 0.3s;
            font-size: 0.9rem;
        }

        .footer-links a:hover {
            color: transparent;
            background: linear-gradient(45deg, #ff8a00, #e52e71);
            background-clip: text;
            -webkit-background-clip: text;
            transform: scale(1.1);
            transition: transform 0.3s ease-in-out;
        }

        .footer-links h6 {
            color: #fff;
            margin: 0;
            font-weight: 400;
            font-size: 0.9rem;
        }

        /* Add this to your CSS styles section */
        .otp-info {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        #forgot-otp-section,
        #delete-otp-section {
            margin-top: 15px;
            margin-bottom: 15px;
        }

        #forgot-otp,
        #delete-otp {
            letter-spacing: 2px;
            font-size: 1.2rem;
            text-align: center;
        }

        .resend-otp {
            display: block;
            margin-top: 10px;
            font-size: 0.8rem;
            color: #667eea;
            text-align: right;
            cursor: pointer;
        }

        .resend-otp:hover {
            text-decoration: underline;
        }

        .countdown {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
            text-align: right;
        }
    </style>
    <!-- Font Awesome for social icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
    <div class="container">
        <div class="site-branding">
            <div class="logo-container">
                <div class="logo">
                    <span class="fire">Fire</span><span class="fly">Fly</span><span class="nox">-NOX</span>
                </div>
            </div>
            <div class="tagline">Illuminate Your Digital Journey</div>
        </div>
        <div class="forms-container">
            <div class="signin-signup">
                <h2>Sign In</h2>
                <div class="form">
                    <div class="input-field">
                        <input type="text" id="login-username" required>
                        <label for="login-username">Username</label>
                    </div>
                    <div class="input-field">
                        <input type="password" id="login-password" required>
                        <label for="login-password">Password</label>
                    </div>
                    <div class="remember-me">
                        <input type="checkbox" id="remember-me" class="remember-checkbox">
                        <label for="remember-me">Remember me</label>
                    </div>
                    <div class="account-actions">
                        <a href="#" id="forgot-password-link">Forgot Password?</a>
                        <a href="#" id="delete-account-link">Delete Account</a>
                    </div>
                    <div id="logged-in-actions" style="display: none;">
                        <button class="btn" id="logout-btn">Log Out</button>
                        <p id="logged-in-message">You are currently logged in.</p>
                    </div>
                    <div class="loading" id="login-loading"></div>
                    <div class="feedback-message" id="login-error"></div>
                    <div class="success-message" id="login-success"></div>
                    <button class="btn" id="login-btn">Sign In</button>
                </div>
                <p class="mobile-nav">Don't have an account? <a class="mobile-link" id="mobile-signup">Sign up</a></p>
            </div>
            <div class="signup-signin">
                <h2>Sign Up</h2>
                <div class="form">
                    <div class="input-field">
                        <input type="text" id="signup-name" required>
                        <label for="signup-name">Full Name</label>
                    </div>
                    <div class="input-field">
                        <input type="text" id="signup-username" required>
                        <label for="signup-username">Username</label>
                    </div>
                    <div class="input-field">
                        <input type="email" id="signup-email" required>
                        <label for="signup-email">Email</label>
                    </div>
                    <div class="input-field">
                        <input type="password" id="signup-password" required>
                        <label for="signup-password">Password</label>
                    </div>
                    <div class="input-field">
                        <input type="text" id="signup-connectionid" value="null" style="display: none;">
                        <label for="signup-connectionid" style="display: none;">Connection ID</label>
                    </div>
                    <div class="loading" id="signup-loading"></div>
                    <div class="feedback-message" id="signup-error"></div>
                    <div class="success-message" id="signup-success"></div>
                    <button class="btn" id="signup-btn">Sign Up</button>
                </div>
                <p class="mobile-nav">Already have an account? <a class="mobile-link" id="mobile-signin">Sign in</a></p>
            </div>
        </div>
        <div class="panels-container">
            <div class="panel left-panel">
                <h2>New to FireFly-NOX?</h2>
                <p>Join our community and discover a world of possibilities. Sign up today to unlock all features!</p>
                <button class="btn" id="signup-panel-btn">Get Started</button>
            </div>
            <div class="panel right-panel">
                <h2>Welcome Back!</h2>
                <p>We're excited to see you again. Sign in to continue your journey with FireFly-NOX.</p>
                <button class="btn" id="signin-panel-btn">Sign In</button>
            </div>
        </div>
    </div>

    <!-- Updated Firebase SDK with stable version -->
    <script type="module">
        // Import the functions you need from the SDKs using a verified stable version
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, deleteUser, sendPasswordResetEmail, reauthenticateWithCredential, EmailAuthProvider, connectAuthEmulator } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getDatabase, ref, set, get, child, remove, update, connectDatabaseEmulator } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { getFunctions, httpsCallable, connectFunctionsEmulator } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-functions.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCE6TCWkVX_1MZgCn8vt0pEek9NHMzOTxY",
            authDomain: "firefly-nox.firebaseapp.com",
            databaseURL: "https://firefly-nox-default-rtdb.firebaseio.com",
            projectId: "firefly-nox",
            storageBucket: "firefly-nox.firebasestorage.app",
            messagingSenderId: "559331235791",
            appId: "1:559331235791:web:a700ea6ecf6a9167c7a4ba",
            measurementId: "G-SYE8N2HCYH"
        };

        // Flag to track if we should use local fallback
        let useLocalFallback = false;
        let auth, database, app;

        // Try to initialize Firebase but be prepared for failure
        try {
            // Initialize Firebase
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            database = getDatabase(app);

            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            useLocalFallback = true;
        }

        // Store user data based on remember me option
        function storeUserData(userData, rememberMe) {
            console.log('ðŸ“ Storing user data:', userData);

            // Always store in sessionStorage (for current session)
            sessionStorage.setItem('currentUser', JSON.stringify(userData));

            // CRITICAL: Store essential data in localStorage for chat.html auth check
            localStorage.setItem('userId', userData.uid);
            localStorage.setItem('userName', userData.name || userData.username || 'User');
            localStorage.setItem('isLoggedOut', 'false'); // Mark as logged in

            // Store profile picture if available
            if (userData.profilePicture) {
                localStorage.setItem('userProfilePic', userData.profilePicture);
            }

            // If remember me is checked, also store in localStorage
            if (rememberMe) {
                // Store persistent login data
                localStorage.setItem('rememberedUser', JSON.stringify({
                    userData: userData,
                    timestamp: Date.now() // Add timestamp for expiry check
                }));
                console.log("âœ… User will be remembered for future sessions");
            } else {
                // Clear any existing remembered user
                localStorage.removeItem('rememberedUser');
            }

            console.log('âœ… User data stored successfully');
        }

        // Check for remembered user on page load
        function checkForRememberedUser() {
            const rememberedUserJson = localStorage.getItem('rememberedUser');
            if (!rememberedUserJson) return null;

            try {
                const rememberedUser = JSON.parse(rememberedUserJson);

                // Check if the remembered login is still valid (30 days expiry)
                const thirtyDaysInMs = 30 * 24 * 60 * 60 * 1000;
                if (Date.now() - rememberedUser.timestamp > thirtyDaysInMs) {
                    console.log("Remembered login expired, clearing");
                    localStorage.removeItem('rememberedUser');
                    return null;
                }

                // Update timestamp to extend the session
                rememberedUser.timestamp = Date.now();
                localStorage.setItem('rememberedUser', JSON.stringify(rememberedUser));

                return rememberedUser.userData;
            } catch (e) {
                console.error("Error parsing remembered user:", e);
                localStorage.removeItem('rememberedUser');
                return null;
            }
        }

        // Check if user is currently logged in
        function checkCurrentSession() {
            // First check session storage (current tab session)
            const currentUserJson = sessionStorage.getItem('currentUser');
            if (currentUserJson) {
                try {
                    return JSON.parse(currentUserJson);
                } catch (e) {
                    console.error("Error parsing current user:", e);
                    sessionStorage.removeItem('currentUser');
                }
            }

            // If no session storage, check if there's a remembered user
            return checkForRememberedUser();
        }

        // Add a function to log out the user
        function logoutUser() {
            // Clear both session and local storage
            sessionStorage.removeItem('currentUser');
            localStorage.removeItem('rememberedUser');

            // If using Firebase, sign out from there too
            if (!useLocalFallback && auth) {
                signOut(auth).catch((error) => {
                    console.error("Error signing out:", error);
                });
            }

            // Redirect to login page or show login form
            showSigninForm();

            return true;
        }

        // Update the redirectToDashboard function in the Firebase authentication script
        function redirectToDashboard(userId, delay = 2000) {
            setTimeout(() => {
                try {
                    // Construct URL with UID parameter
                    const dashboardUrl = `chat.html?uid=${encodeURIComponent(userId)}`;

                    // Navigate to dashboard with UID
                    window.location.href = dashboardUrl;
                } catch (e) {
                    console.error("Error during redirection:", e);
                    alert("There was an error redirecting to the dashboard.");
                }
            }, delay);
        }

        document.addEventListener('DOMContentLoaded', function () {
            console.log("DOM loaded, setting up authentication system");

            // Check for remembered user first
            const rememberedUser = checkForRememberedUser();
            if (rememberedUser) {
                console.log("Found remembered user:", rememberedUser.username || rememberedUser.email);
                // Store in session storage for current session
                sessionStorage.setItem('currentUser', JSON.stringify(rememberedUser));

                // Show a quick message and redirect
                const loginSuccess = document.getElementById('login-success');
                loginSuccess.textContent = `Welcome back, ${rememberedUser.name || rememberedUser.username}! Redirecting...`;

                setTimeout(() => {
                    // Redirect to dashboard
                    redirectToDashboard(rememberedUser.uid);
                }, 2000);
            }

            // DOM elements and UI setup
            const container = document.querySelector('.container');
            const signupForm = document.querySelector('.signup-signin');

            // Local storage keys for fallback
            const USERS_STORAGE_KEY = 'local_auth_users';

            // Initialize UI components and event listeners
            initializeUI();

            // Main UI initialization function
            function initializeUI() {
                // Set up form switching buttons
                document.getElementById('signup-panel-btn').addEventListener('click', showSignupForm);
                document.getElementById('signin-panel-btn').addEventListener('click', showSigninForm);
                document.getElementById('mobile-signup').addEventListener('click', showSignupForm);
                document.getElementById('mobile-signin').addEventListener('click', showSigninForm);

                // Set up input animations
                setupInputAnimations();

                // Set up form submission on Enter key
                setupFormSubmitOnEnter();

                // Set up login button with appropriate handler
                document.getElementById('login-btn').addEventListener('click', useLocalFallback ? handleLocalLogin : handleFirebaseLogin);

                // Set up signup button with appropriate handler
                document.getElementById('signup-btn').addEventListener('click', useLocalFallback ? handleLocalSignup : handleFirebaseSignup);

                // Test form switching (ensures both forms work visually)
                console.log("Testing form switching");
                setTimeout(() => document.getElementById('signup-panel-btn').click(), 100);
                setTimeout(() => document.getElementById('signin-panel-btn').click(), 500);

                // Add a notice if we're using local fallback
                if (useLocalFallback) {
                    const notice = document.createElement('div');
                    notice.style.position = 'fixed';
                    notice.style.bottom = '10px';
                    notice.style.left = '10px';
                    notice.style.backgroundColor = 'rgba(255, 193, 7, 0.8)';
                    notice.style.color = '#333';
                    notice.style.padding = '8px 15px';
                    notice.style.borderRadius = '4px';
                    notice.style.fontSize = '14px';
                    notice.style.zIndex = '1000';
                    notice.textContent = 'Using local authentication (Firebase unavailable)';
                    document.body.appendChild(notice);

                    console.log("LOCAL FALLBACK MODE: Firebase configuration not found, using local storage for auth");
                }

                // Set up account management links
                document.getElementById('forgot-password-link').addEventListener('click', showForgotPasswordModal);
                document.getElementById('delete-account-link').addEventListener('click', showDeleteAccountModal);

                // Modal close buttons
                document.getElementById('forgot-cancel-btn').addEventListener('click', hideForgotPasswordModal);
                document.getElementById('delete-cancel-btn').addEventListener('click', hideDeleteAccountModal);

                // Modal submit buttons
                document.getElementById('forgot-submit-btn').addEventListener('click', handleForgotPassword);
                document.getElementById('delete-verify-btn').addEventListener('click', handleDeleteAccount);
            }

            // Form switching functions
            function showSignupForm(e) {
                if (e) e.preventDefault();
                console.log("Showing signup form");

                // Add animation class before changing active state
                document.querySelector('.signin-signup').classList.add('form-exit');
                document.querySelector('.signup-signin').classList.add('form-enter');

                setTimeout(() => {
                    container.classList.add('active');
                    signupForm.classList.add('active');
                    clearFormMessages();

                    // Remove animation classes after transition
                    setTimeout(() => {
                        document.querySelector('.signin-signup').classList.remove('form-exit');
                        document.querySelector('.signup-signin').classList.remove('form-enter');
                    }, 500);
                }, 50);
            }

            function showSigninForm(e) {
                if (e) e.preventDefault();
                console.log("Showing signin form");

                // Add animation class before changing active state
                document.querySelector('.signup-signin').classList.add('form-exit');
                document.querySelector('.signin-signup').classList.add('form-enter');

                setTimeout(() => {
                    container.classList.remove('active');
                    signupForm.classList.remove('active');
                    clearFormMessages();

                    // Remove animation classes after transition
                    setTimeout(() => {
                        document.querySelector('.signup-signin').classList.remove('form-exit');
                        document.querySelector('.signin-signup').classList.remove('form-enter');
                    }, 500);
                }, 50);
            }

            // Clear form messages
            function clearFormMessages() {
                document.getElementById('signup-error').textContent = '';
                document.getElementById('signup-success').textContent = '';
                document.getElementById('login-error').textContent = '';
                document.getElementById('login-success').textContent = '';
            }

            // Input field animations
            function setupInputAnimations() {
                const inputs = document.querySelectorAll('input');
                inputs.forEach(input => {
                    // Initial state check
                    updateInputLabel(input);

                    // Event listeners
                    input.addEventListener('focus', () => {
                        const label = input.nextElementSibling;
                        if (label && label.tagName === 'LABEL') {
                            label.classList.add('active');
                        }
                    });

                    input.addEventListener('blur', () => updateInputLabel(input));
                    input.addEventListener('input', () => updateInputLabel(input));
                });
            }

            // Helper for input animations
            function updateInputLabel(input) {
                const label = input.nextElementSibling;
                if (label && label.tagName === 'LABEL') {
                    if (input.value !== '') {
                        label.classList.add('active');
                    } else {
                        label.classList.remove('active');
                    }
                }
            }

            // Local storage helper functions for fallback mode
            function getUsers() {
                const usersJson = localStorage.getItem(USERS_STORAGE_KEY);
                return usersJson ? JSON.parse(usersJson) : {};
            }

            function saveUser(email, userData) {
                const users = getUsers();
                users[email.toLowerCase()] = userData;
                localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(users));
            }

            function getUserByEmail(email) {
                const users = getUsers();
                return users[email.toLowerCase()];
            }

            // Local login handler (fallback when Firebase fails)
            function handleLocalLogin() {
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                const rememberMe = document.getElementById('remember-me').checked;
                const loginLoading = document.getElementById('login-loading');
                const loginError = document.getElementById('login-error');
                const loginSuccess = document.getElementById('login-success');

                // Reset messages
                loginError.textContent = '';
                loginSuccess.textContent = '';

                // Basic validation
                if (!username || !password) {
                    loginError.textContent = 'Please fill in all fields';
                    return;
                }

                // Show loading indicator
                loginLoading.style.display = 'block';
                document.getElementById('login-btn').disabled = true;

                // Simulate network delay for better UX
                setTimeout(() => {
                    // Find user by username instead of email
                    const user = findUserByUsername(username);

                    if (!user) {
                        loginError.textContent = 'No account found with this username';
                    } else if (user.password !== password) {
                        loginError.textContent = 'Incorrect password';
                    } else {
                        // Successful login
                        loginSuccess.textContent = 'Login successful! Redirecting...';

                        // Clear form
                        document.getElementById('login-username').value = '';
                        document.getElementById('login-password').value = '';

                        // Create user data object without password
                        const userData = {
                            name: user.name,
                            username: user.username,
                            email: user.email,
                            createdAt: user.createdAt,
                            uid: generateLocalUserUid() // Add a function to generate a local UID
                        };

                        // Store user data based on remember me option
                        storeUserData(userData, rememberMe);

                        // Use the common redirection function with the generated UID
                        redirectToDashboard(userData.uid);
                    }

                    // Hide loading and enable button
                    loginLoading.style.display = 'none';
                    document.getElementById('login-btn').disabled = false;
                }, 1000);
            }

            // Local signup handler (fallback when Firebase fails)
            function handleLocalSignup() {
                const name = document.getElementById('signup-name').value;
                const username = document.getElementById('signup-username').value;
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                const connectionId = document.getElementById('signup-connectionid').value || null;

                const signupLoading = document.getElementById('signup-loading');
                const signupError = document.getElementById('signup-error');
                const signupSuccess = document.getElementById('signup-success');

                // Reset messages
                signupError.textContent = '';
                signupSuccess.textContent = '';

                // Validation
                if (!name || !username || !email || !password) {
                    signupError.textContent = 'Please fill in all fields';
                    return;
                }

                if (password.length < 6) {
                    signupError.textContent = 'Password should be at least 6 characters';
                    return;
                }

                // Check if username already exists
                const users = getUsers();
                for (const key in users) {
                    if (users[key].username === username) {
                        signupError.textContent = 'Username is already taken';
                        return;
                    }
                }

                // Email format validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    signupError.textContent = 'Invalid email format';
                    return;
                }

                // Show loading
                signupLoading.style.display = 'block';
                document.getElementById('signup-btn').disabled = true;

                // Simulate network delay for better UX
                setTimeout(() => {
                    // Check if user already exists
                    const existingUser = getUserByEmail(email);

                    if (existingUser) {
                        signupError.textContent = 'Email is already in use';
                    } else {
                        // Create new user
                        const newUser = {
                            name: name,
                            username: username,
                            email: email,
                            password: password,
                            connectionId: connectionId, // Include connectionId here
                            createdAt: new Date().toISOString()
                        };

                        // Save user to local storage
                        saveUser(email, newUser);

                        signupSuccess.textContent = 'Account created successfully! Redirecting to login...';

                        // Clear form
                        document.getElementById('signup-name').value = '';
                        document.getElementById('signup-username').value = '';
                        document.getElementById('signup-email').value = '';
                        document.getElementById('signup-password').value = '';
                        document.getElementById('signup-connectionid').value = '';

                        // Switch to login form after 2 seconds
                        setTimeout(() => {
                            showSigninForm();
                        }, 2000);
                    }

                    // Hide loading
                    signupLoading.style.display = 'none';
                    document.getElementById('signup-btn').disabled = false;
                }, 1000);
            }

            // Firebase login handler
            function handleFirebaseLogin() {
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                const rememberMe = document.getElementById('remember-me').checked;
                const loginLoading = document.getElementById('login-loading');
                const loginError = document.getElementById('login-error');
                const loginSuccess = document.getElementById('login-success');

                // Reset messages
                loginError.textContent = '';
                loginSuccess.textContent = '';

                // Basic validation
                if (!username || !password) {
                    loginError.textContent = 'Please fill in all fields';
                    return;
                }

                // Show loading indicator
                loginLoading.style.display = 'block';
                document.getElementById('login-btn').disabled = true;

                // First, find the email associated with this username
                const dbRef = ref(database);

                get(child(dbRef, 'users'))
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            let userEmail = null;
                            let userData = null;
                            let userId = null;

                            // Find user with matching username
                            snapshot.forEach((childSnapshot) => {
                                const user = childSnapshot.val();
                                if (user.username === username) {
                                    userEmail = user.email;
                                    userData = user;
                                    userId = childSnapshot.key;
                                }
                            });

                            if (!userEmail) {
                                loginError.textContent = 'No account found with this username';
                                loginLoading.style.display = 'none';
                                document.getElementById('login-btn').disabled = false;
                                return;
                            }

                            // Now proceed with Firebase authentication using the email
                            signInWithEmailAndPassword(auth, userEmail, password)
                                .then((userCredential) => {
                                    // Signed in 
                                    const user = userCredential.user;
                                    console.log("Login successful for user:", user.uid);

                                    // Retrieve additional user data from database
                                    get(child(ref(database), `users/${user.uid}`))
                                        .then((snapshot) => {
                                            if (snapshot.exists()) {
                                                const userData = snapshot.val();
                                                userData.uid = user.uid;

                                                // Store user data
                                                storeUserData(userData, rememberMe);

                                                // Redirect with UID
                                                redirectToDashboard(user.uid);
                                            } else {
                                                // Fallback if no additional data found
                                                redirectToDashboard(user.uid);
                                            }
                                        })
                                        .catch((error) => {
                                            console.error("Error retrieving user data:", error);
                                            redirectToDashboard(user.uid);
                                        });
                                })
                                .catch((error) => {
                                    console.error("Login error:", error.code, error.message);

                                    // Handle Firebase errors
                                    if (error.code === 'auth/configuration-not-found') {
                                        console.log("Switching to local fallback for this session");
                                        useLocalFallback = true;
                                        document.getElementById('login-btn').removeEventListener('click', handleFirebaseLogin);
                                        document.getElementById('login-btn').addEventListener('click', handleLocalLogin);

                                        // Try again with local auth
                                        loginError.textContent = 'Firebase unavailable, trying local authentication...';
                                        setTimeout(() => handleLocalLogin(), 500);
                                        return;
                                    }

                                    // Handle other errors
                                    if (error.code === 'auth/wrong-password') {
                                        loginError.textContent = 'Incorrect password';
                                    } else if (error.code === 'auth/too-many-requests') {
                                        loginError.textContent = 'Too many failed attempts. Try again later';
                                    } else {
                                        loginError.textContent = 'Login failed: ' + error.message;
                                    }
                                })
                                .finally(() => {
                                    // Hide loading and enable button
                                    loginLoading.style.display = 'none';
                                    document.getElementById('login-btn').disabled = false;
                                });
                        } else {
                            // No users found
                            loginError.textContent = 'No account found with this username';
                            loginLoading.style.display = 'none';
                            document.getElementById('login-btn').disabled = false;
                        }
                    })
                    .catch((error) => {
                        console.error("Error finding user:", error);

                        // Switch to local fallback if we get configuration error
                        if (error.code === 'app/configuration-not-found' || error.code === 'auth/configuration-not-found') {
                            console.log("Switching to local fallback for this session");
                            useLocalFallback = true;
                            document.getElementById('login-btn').removeEventListener('click', handleFirebaseLogin);
                            document.getElementById('login-btn').addEventListener('click', handleLocalLogin);

                            // Try again with local auth
                            loginError.textContent = 'Firebase unavailable, trying local authentication...';
                            setTimeout(() => handleLocalLogin(), 500);
                            return;
                        }

                        loginError.textContent = 'Error finding user: ' + error.message;
                        loginLoading.style.display = 'none';
                        document.getElementById('login-btn').disabled = false;
                    });
            }

            // Firebase signup handler
            function handleFirebaseSignup() {
                const name = document.getElementById('signup-name').value;
                const username = document.getElementById('signup-username').value;
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;

                // Get the connectionId value from the input field
                const connectionId = document.getElementById('signup-connectionid').value || null;

                const signupLoading = document.getElementById('signup-loading');
                const signupError = document.getElementById('signup-error');
                const signupSuccess = document.getElementById('signup-success');

                // Reset messages
                signupError.textContent = '';
                signupSuccess.textContent = '';

                // Validation
                if (!name || !username || !email || !password) {
                    signupError.textContent = 'Please fill in all fields';
                    return;
                }

                if (password.length < 6) {
                    signupError.textContent = 'Password should be at least 6 characters';
                    return;
                }

                // Email format validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    signupError.textContent = 'Invalid email format';
                    return;
                }

                // Show loading
                signupLoading.style.display = 'block';
                document.getElementById('signup-btn').disabled = true;

                // Check if username already exists
                const dbRef = ref(database);

                // First check if username is already taken
                get(child(dbRef, 'users'))
                    .then((snapshot) => {
                        let usernameExists = false;

                        if (snapshot.exists()) {
                            // Check all users for matching username
                            snapshot.forEach((childSnapshot) => {
                                const userData = childSnapshot.val();
                                if (userData.username === username) {
                                    usernameExists = true;
                                }
                            });
                        }

                        if (usernameExists) {
                            signupError.textContent = 'Username is already taken';
                            signupLoading.style.display = 'none';
                            document.getElementById('signup-btn').disabled = false;
                            return;
                        }

                        // If username is available, proceed with signup
                        createUserWithEmailAndPassword(auth, email, password)
                            .then((userCredential) => {
                                // Signed up 
                                const user = userCredential.user;
                                console.log("User created successfully:", user.uid);

                                // Save additional user data to Firebase Realtime Database
                                set(ref(database, 'users/' + user.uid), {
                                    name: name,
                                    username: username,
                                    email: email,
                                    connectionId: connectionId, // Store the connectionId here
                                    createdAt: new Date().toISOString()
                                })
                                    .then(() => {
                                        console.log("User data saved to database");
                                        signupSuccess.textContent = 'Account created successfully! Redirecting to login...';

                                        // Clear form
                                        document.getElementById('signup-name').value = '';
                                        document.getElementById('signup-username').value = '';
                                        document.getElementById('signup-email').value = '';
                                        document.getElementById('signup-password').value = '';
                                        document.getElementById('signup-connectionid').value = '';

                                        // Switch to login form after 2 seconds
                                        setTimeout(() => {
                                            showSigninForm();
                                        }, 2000);
                                    })
                                    .catch(error => {
                                        // Still show success even if database save fails
                                        console.error("Error saving user data:", error);
                                        signupSuccess.textContent = 'Account created successfully! Redirecting to login...';
                                        setTimeout(() => {
                                            showSigninForm();
                                        }, 2000);
                                    })
                                    .finally(() => {
                                        // Hide loading
                                        signupLoading.style.display = 'none';
                                        document.getElementById('signup-btn').disabled = false;
                                    });
                            })
                            .catch((error) => {
                                console.error("Signup error:", error.code, error.message);

                                // Switch to local fallback if we get configuration error
                                if (error.code === 'auth/configuration-not-found') {
                                    console.log("Switching to local fallback for this session");
                                    useLocalFallback = true;
                                    document.getElementById('signup-btn').removeEventListener('click', handleFirebaseSignup);
                                    document.getElementById('signup-btn').addEventListener('click', handleLocalSignup);

                                    // Try again with local auth
                                    signupError.textContent = 'Firebase unavailable, trying local authentication...';
                                    setTimeout(() => handleLocalSignup(), 500);
                                    return;
                                }

                                // Handle other Firebase errors
                                if (error.code === 'auth/email-already-in-use') {
                                    signupError.textContent = 'Email is already in use';
                                } else if (error.code === 'auth/invalid-email') {
                                    signupError.textContent = 'Invalid email format';
                                } else if (error.code === 'auth/weak-password') {
                                    signupError.textContent = 'Password is too weak';
                                } else {
                                    signupError.textContent = 'Sign up failed: ' + error.message;
                                }

                                // Hide loading
                                signupLoading.style.display = 'none';
                                document.getElementById('signup-btn').disabled = false;
                            });
                    })
                    .catch((error) => {
                        console.error("Error checking username:", error);

                        // If we can't check for duplicate usernames, just proceed with registration
                        if (error.code === 'app/configuration-not-found' || error.code === 'auth/configuration-not-found') {
                            useLocalFallback = true;
                            signupError.textContent = 'Firebase unavailable, trying local authentication...';
                            setTimeout(() => handleLocalSignup(), 500);
                            return;
                        }

                        // Error handling...
                    });
            }

            // Forgot password functions
            function showForgotPasswordModal(e) {
                if (e) e.preventDefault();

                // Reset form
                document.getElementById('forgot-email').value = '';
                document.getElementById('forgot-error').textContent = '';
                document.getElementById('forgot-success').textContent = '';
                document.getElementById('forgot-loading').style.display = 'none';

                // Reset button
                document.getElementById('forgot-submit-btn').textContent = 'Send Reset Link';
                document.getElementById('forgot-submit-btn').style.display = 'inline-block';
                document.getElementById('forgot-submit-btn').disabled = false;

                // Show modal
                document.getElementById('forgot-password-overlay').style.display = 'flex';

                // Setup input animations for modal fields
                setupInputAnimations();
            }

            function hideForgotPasswordModal() {
                document.getElementById('forgot-password-overlay').style.display = 'none';
            }

            // Replace your existing handleForgotPassword function with this version
            function handleForgotPassword() {
                const email = document.getElementById('forgot-email').value;
                const errorElement = document.getElementById('forgot-error');
                const successElement = document.getElementById('forgot-success');
                const loadingElement = document.getElementById('forgot-loading');
                const submitButton = document.getElementById('forgot-submit-btn');

                // Reset messages
                errorElement.textContent = '';
                successElement.textContent = '';

                // Basic validation
                if (!email) {
                    errorElement.textContent = 'Please enter your email address';
                    return;
                }

                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    errorElement.textContent = 'Please enter a valid email address';
                    return;
                }

                // Show loading
                loadingElement.style.display = 'block';
                submitButton.disabled = true;

                if (useLocalFallback) {
                    // For local fallback, we can only check if the account exists
                    setTimeout(() => {
                        const user = getUserByEmail(email);

                        if (!user) {
                            errorElement.textContent = 'No account exists with this email address';
                        } else {
                            successElement.textContent = 'In a live environment, a password reset link would be sent to your email. Since we are in local mode, please contact support.';
                        }

                        loadingElement.style.display = 'none';
                        submitButton.disabled = false;
                    }, 1000);
                } else {
                    // Use Firebase password reset
                    sendPasswordResetEmail(auth, email)
                        .then(() => {
                            // Password reset email sent
                            successElement.textContent = 'Password reset email sent! Check your inbox and follow the instructions.';
                            document.getElementById('forgot-email').value = '';

                            // Hide the button to prevent multiple requests
                            submitButton.style.display = 'none';

                            // Close modal after 5 seconds
                            setTimeout(() => {
                                hideForgotPasswordModal();
                                // Reset the button for next time
                                submitButton.style.display = 'inline-block';
                            }, 5000);
                        })
                        .catch((error) => {
                            console.error("Password reset error:", error);

                            // Handle different error codes
                            switch (error.code) {
                                case 'auth/user-not-found':
                                    errorElement.textContent = 'No account exists with this email address';
                                    break;
                                case 'auth/invalid-email':
                                    errorElement.textContent = 'Please enter a valid email address';
                                    break;
                                case 'auth/too-many-requests':
                                    errorElement.textContent = 'Too many requests. Please try again later.';
                                    break;
                                default:
                                    errorElement.textContent = 'Error sending reset email: ' + error.message;
                            }
                        })
                        .finally(() => {
                            loadingElement.style.display = 'none';
                            submitButton.disabled = false;
                        });
                }
            }

            // Delete account functions
            function showDeleteAccountModal(e) {
                if (e) e.preventDefault();

                // Reset form
                document.getElementById('delete-email').value = '';
                document.getElementById('delete-password').value = '';
                document.getElementById('confirm-delete-section').style.display = 'none';
                document.getElementById('delete-error').textContent = '';
                document.getElementById('delete-success').textContent = '';
                document.getElementById('delete-loading').style.display = 'none';

                // Reset button text and style
                const verifyButton = document.getElementById('delete-verify-btn');
                verifyButton.textContent = 'Verify';
                verifyButton.classList.remove('modal-btn-danger');
                verifyButton.classList.add('modal-btn-primary');
                verifyButton.style.display = 'inline-block';
                verifyButton.disabled = false;

                // Clear stored data
                delete document.getElementById('delete-account-overlay').dataset.email;

                // Show modal
                document.getElementById('delete-account-overlay').style.display = 'flex';

                // Setup input animations for modal fields
                setupInputAnimations();
            }

            function hideDeleteAccountModal() {
                document.getElementById('delete-account-overlay').style.display = 'none';
            }

            // Replace your existing handleDeleteAccount function with this version
            function handleDeleteAccount() {
                const email = document.getElementById('delete-email').value;
                const confirmSection = document.getElementById('confirm-delete-section');
                const errorElement = document.getElementById('delete-error');
                const successElement = document.getElementById('delete-success');
                const loadingElement = document.getElementById('delete-loading');
                const verifyButton = document.getElementById('delete-verify-btn');

                // Reset messages
                errorElement.textContent = '';
                successElement.textContent = '';

                // Determine the current step based on what's visible
                const inVerificationMode = confirmSection.style.display === 'none';
                const inConfirmationMode = confirmSection.style.display !== 'none';

                // Handle initial verification step
                if (inVerificationMode) {
                    // Basic validation
                    if (!email) {
                        errorElement.textContent = 'Please enter your email address';
                        return;
                    }

                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        errorElement.textContent = 'Please enter a valid email address';
                        return;
                    }

                    // Show loading
                    loadingElement.style.display = 'block';
                    verifyButton.disabled = true;

                    setTimeout(() => {
                        let userExists = false;

                        if (useLocalFallback) {
                            // Check local storage
                            const user = getUserByEmail(email);
                            userExists = !!user;
                        } else {
                            // For Firebase, we need to check if the current user's email matches
                            const currentUser = auth.currentUser;
                            if (currentUser && currentUser.email === email) {
                                userExists = true;
                            } else {
                                errorElement.textContent = 'You can only delete the account you are currently logged into';
                                loadingElement.style.display = 'none';
                                verifyButton.disabled = false;
                                return;
                            }
                        }

                        if (!userExists) {
                            errorElement.textContent = 'No account found with this email address';
                        } else {
                            // Show confirmation section
                            confirmSection.style.display = 'block';
                            successElement.textContent = 'Email verified! Please confirm account deletion.';

                            // Change button text and style
                            verifyButton.textContent = 'Delete Account';
                            verifyButton.classList.remove('modal-btn-primary');
                            verifyButton.classList.add('modal-btn-danger');

                            // Store email for confirmation step
                            document.getElementById('delete-account-overlay').dataset.email = email;
                        }

                        loadingElement.style.display = 'none';
                        verifyButton.disabled = false;
                    }, 1000);
                }
                // Handle confirmation step
                else if (inConfirmationMode) {
                    const password = document.getElementById('delete-password').value;
                    const storedEmail = document.getElementById('delete-account-overlay').dataset.email;

                    // Validate password
                    if (!password) {
                        errorElement.textContent = 'Please enter your password to confirm';
                        return;
                    }

                    // Show loading
                    loadingElement.style.display = 'block';
                    verifyButton.disabled = true;

                    setTimeout(async () => {
                        try {
                            let accountDeleted = false;

                            if (useLocalFallback) {
                                // For local fallback, verify the password and delete
                                const user = getUserByEmail(storedEmail);

                                if (!user || user.password !== password) {
                                    errorElement.textContent = 'Incorrect password';
                                    loadingElement.style.display = 'none';
                                    verifyButton.disabled = false;
                                    return;
                                }

                                // Delete from local storage
                                accountDeleted = deleteUserByEmail(storedEmail);
                            } else {
                                // For Firebase, re-authenticate and then delete
                                const currentUser = auth.currentUser;

                                if (!currentUser) {
                                    errorElement.textContent = 'You must be logged in to delete your account';
                                    loadingElement.style.display = 'none';
                                    verifyButton.disabled = false;
                                    return;
                                }

                                try {
                                    // Re-authenticate with email/password
                                    const credential = EmailAuthProvider.credential(storedEmail, password);
                                    await reauthenticateWithCredential(currentUser, credential);

                                    // Delete the user from Firebase Authentication
                                    await deleteUser(currentUser);

                                    // Also delete user data from Realtime Database if it exists
                                    try {
                                        // Try to find and delete the user record from the database
                                        const dbRef = ref(database, 'users');
                                        const snapshot = await get(dbRef);

                                        if (snapshot.exists()) {
                                            let userId = null;

                                            snapshot.forEach((childSnapshot) => {
                                                const userData = childSnapshot.val();
                                                if (userData.email === storedEmail) {
                                                    userId = childSnapshot.key;
                                                }
                                            });

                                            if (userId) {
                                                await remove(ref(database, `users/${userId}`));
                                            }
                                        }
                                    } catch (dbError) {
                                        console.error("Error removing user data from database:", dbError);
                                        // Continue even if database deletion fails
                                    }

                                    accountDeleted = true;
                                } catch (authError) {
                                    console.error("Error during re-authentication or deletion:", authError);

                                    if (authError.code === 'auth/wrong-password') {
                                        errorElement.textContent = 'Incorrect password';
                                    } else {
                                        errorElement.textContent = 'Error deleting account: ' + authError.message;
                                    }

                                    loadingElement.style.display = 'none';
                                    verifyButton.disabled = false;
                                    return;
                                }
                            }

                            if (accountDeleted) {
                                successElement.textContent = 'Account deleted successfully!';

                                // Clear any user session data
                                sessionStorage.removeItem('currentUser');
                                localStorage.removeItem('rememberedUser');

                                // Hide confirmation section and button
                                confirmSection.style.display = 'none';
                                verifyButton.style.display = 'none';

                                // Close modal after delay
                                setTimeout(() => {
                                    hideDeleteAccountModal();

                                    // Reload page to reset UI state
                                    window.location.reload();
                                }, 3000);
                            } else {
                                errorElement.textContent = 'Failed to delete account. Please try again.';
                            }
                        } catch (error) {
                            console.error("Error in account deletion process:", error);
                            errorElement.textContent = 'An error occurred. Please try again.';
                        } finally {
                            loadingElement.style.display = 'none';
                            verifyButton.disabled = false;
                        }
                    }, 1000);
                }
            }

            // Helper functions for local storage operations
            function findUserByUsernameAndEmail(username, email) {
                const users = getUsers();
                const lowerEmail = email.toLowerCase();

                for (const key in users) {
                    const user = users[key];
                    if (user.username === username && user.email.toLowerCase() === lowerEmail) {
                        return user;
                    }
                }

                return null;
            }

            function updateUserPassword(username, email, newPassword) {
                const users = getUsers();
                const lowerEmail = email.toLowerCase();
                let updated = false;

                for (const key in users) {
                    const user = users[key];
                    if (user.username === username && user.email.toLowerCase() === lowerEmail) {
                        user.password = newPassword;
                        updated = true;
                        break;
                    }
                }

                if (updated) {
                    localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(users));
                }

                return updated;
            }

            function deleteUserByUsernameAndEmail(username, email) {
                const users = getUsers();
                const lowerEmail = email.toLowerCase();
                let userKey = null;

                for (const key in users) {
                    const user = users[key];
                    if (user.username === username && user.email.toLowerCase() === lowerEmail) {
                        userKey = key;
                        break;
                    }
                }

                if (userKey) {
                    delete users[userKey];
                    localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(users));
                    return true;
                }

                return false;
            }

            // Add this new helper function for local storage
            function findUserByUsername(username) {
                const users = getUsers();

                for (const key in users) {
                    const user = users[key];
                    if (user.username === username) {
                        return user;
                    }
                }

                return null;
            }

            // Add these functions after your existing helper functions

            // Generate a random 6-digit OTP
            function generateOTP() {
                return Math.floor(100000 + Math.random() * 900000).toString();
            }

            // Store OTP in Firebase 
            async function storeOTPInFirebase(email, otp, purpose) {
                if (useLocalFallback) {
                    // For local fallback, we'll store in localStorage instead
                    const otpData = {
                        email: email,
                        otp: otp,
                        timestamp: Date.now(),
                        purpose: purpose
                    };
                    localStorage.setItem(`otp_${email}`, JSON.stringify(otpData));
                    return true;
                } else {
                    try {
                        // Store OTP in Firebase with an expiration time (10 minutes)
                        const otpRef = ref(database, `otps/${btoa(email)}`);
                        await set(otpRef, {
                            otp: otp,
                            timestamp: Date.now(),
                            expires: Date.now() + (10 * 60 * 1000), // 10 minutes expiry
                            purpose: purpose
                        });
                        return true;
                    } catch (error) {
                        console.error("Error storing OTP:", error);
                        return false;
                    }
                }
            }

            // Replace the sendOTPEmail function with this updated version
            async function sendOTPEmail(email, otp, purpose) {
                // Log for debugging
                console.log(`Sending OTP ${otp} to ${email} for ${purpose}`);

                try {
                    // Create the email content
                    const subject = `Your verification code for ${purpose}`;
                    const htmlBody = `
                        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #e0e0e0; border-radius: 5px;">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <h1 style="color: #667eea; margin-bottom: 5px;">FireFly-NOX</h1>
                                <p style="color: #666; font-style: italic;">Illuminate Your Digital Journey</p>
                            </div>
                            <div style="padding: 20px; background-color: #f9f9f9; border-radius: 5px;">
                                <h2 style="color: #333; margin-bottom: 15px;">Your Verification Code</h2>
                                <p style="color: #666; margin-bottom: 20px;">Please use the following code to complete your ${purpose}:</p>
                                <div style="text-align: center; margin: 30px 0;">
                                    <span style="font-size: 32px; font-weight: bold; letter-spacing: 5px; padding: 10px 30px; background-color: #667eea; color: white; border-radius: 5px;">${otp}</span>
                                </div>
                                <p style="color: #666; margin-bottom: 5px;">This code will expire in 10 minutes.</p>
                                <p style="color: #666;">If you didn't request this code, please ignore this email.</p>
                            </div>
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0; color: #999; font-size: 12px; text-align: center;">
                                <p>&copy; ${new Date().getFullYear()} FireFly-NOX. All rights reserved.</p>
                            </div>
                        </div>
                    `;
                    const textBody = `Your verification code for ${purpose} is: ${otp}. This code will expire in 10 minutes.`;

                    // Use the Email.js library to send email via SMTP
                    const emailData = {
                        Host: "smtp-relay.brevo.com",
                        Username: "8925b4002@smtp-brevo.com",
                        Password: "4QdgMqEvaX3P7Fyb",
                        Port: 587,
                        To: email,
                        From: "no-reply@firefly-nox.com",
                        Subject: subject,
                        Body: htmlBody,
                        SecureToken: "your-secure-token" // Optional if needed
                    };

                    // Use fetch with Brevo's API V3 endpoint
                    const response = await fetch('https://api.sendinblue.com/v3/smtp/email', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'api-key': '4QdgMqEvaX3P7Fyb'
                        },
                        body: JSON.stringify({
                            sender: {
                                name: "FireFly-NOX",
                                email: "no-reply@firefly-nox.com"
                            },
                            to: [{
                                email: email
                            }],
                            subject: subject,
                            htmlContent: htmlBody,
                            textContent: textBody
                        })
                    });

                    if (response.ok) {
                        console.log("Verification code email sent successfully");
                        return true;
                    } else {
                        const errorResult = await response.json();
                        console.error("Brevo API error:", errorResult);

                        // Fall back to using EmailJS for browser-based sending
                        try {
                            // Create a temporary form to submit
                            const form = document.createElement('form');
                            form.style.display = 'none';
                            form.method = 'POST';
                            form.action = 'https://formsubmit.co/8925b4002@smtp-brevo.com'; // Use FormSubmit as fallback

                            // Add form fields
                            const nameField = document.createElement('input');
                            nameField.type = 'text';
                            nameField.name = 'name';
                            nameField.value = 'FireFly-NOX User';

                            const emailField = document.createElement('input');
                            emailField.type = 'email';
                            emailField.name = 'email';
                            emailField.value = email;

                            const subjectField = document.createElement('input');
                            subjectField.type = 'text';
                            subjectField.name = '_subject';
                            subjectField.value = subject;

                            const messageField = document.createElement('textarea');
                            messageField.name = 'message';
                            messageField.value = `Your verification code is: ${otp}\n\nThis code will expire in 10 minutes.`;

                            // Add hidden fields for FormSubmit configuration
                            const captchaField = document.createElement('input');
                            captchaField.type = 'hidden';
                            captchaField.name = '_captcha';
                            captchaField.value = 'false';

                            const templateField = document.createElement('input');
                            templateField.type = 'hidden';
                            templateField.name = '_template';
                            templateField.value = 'box';

                            // Append all fields to form
                            form.appendChild(nameField);
                            form.appendChild(emailField);
                            form.appendChild(subjectField);
                            form.appendChild(messageField);
                            form.appendChild(captchaField);
                            form.appendChild(templateField);

                            // Append form to body, submit it, and remove it
                            document.body.appendChild(form);

                            console.log("Using FormSubmit fallback to send OTP");

                            // Instead of submitting the form (which would navigate away),
                            // we'll just show a notification and return true
                            console.log("Fallback email sending initiated");
                            return true;
                        } catch (fallbackError) {
                            console.error("Fallback email sending failed:", fallbackError);
                            return false;
                        }
                    }
                } catch (error) {
                    console.error("Error sending OTP email:", error);
                    return false;
                }
            }

            // Verify OTP
            async function verifyOTP(email, userOTP, purpose) {
                if (useLocalFallback) {
                    // Verify against localStorage
                    const otpDataJson = localStorage.getItem(`otp_${email}`);
                    if (!otpDataJson) return false;

                    try {
                        const otpData = JSON.parse(otpDataJson);

                        // Check if OTP is expired (10 minutes)
                        if (Date.now() - otpData.timestamp > 10 * 60 * 1000) {
                            localStorage.removeItem(`otp_${email}`);
                            return { verified: false, reason: 'expired' };
                        }

                        // Check if purpose matches
                        if (otpData.purpose !== purpose) {
                            return { verified: false, reason: 'invalid_purpose' };
                        }

                        // Check if OTP matches
                        if (otpData.otp === userOTP) {
                            // Clean up after successful verification
                            localStorage.removeItem(`otp_${email}`);
                            return { verified: true };
                        } else {
                            return { verified: false, reason: 'invalid_otp' };
                        }
                    } catch (e) {
                        console.error("Error verifying OTP:", e);
                        return { verified: false, reason: 'error' };
                    }
                } else {
                    try {
                        // Verify against Firebase database
                        const otpRef = ref(database, `otps/${btoa(email)}`);
                        const snapshot = await get(otpRef);

                        if (!snapshot.exists()) {
                            return { verified: false, reason: 'not_found' };
                        }

                        const otpData = snapshot.val();

                        // Check if OTP is expired
                        if (Date.now() > otpData.expires) {
                            // Clean up expired OTP
                            remove(otpRef);
                            return { verified: false, reason: 'expired' };
                        }

                        // Check if purpose matches
                        if (otpData.purpose !== purpose) {
                            return { verified: false, reason: 'invalid_purpose' };
                        }

                        // Check if OTP matches
                        if (otpData.otp === userOTP) {
                            // Clean up after successful verification
                            remove(otpRef);
                            return { verified: true };
                        } else {
                            return { verified: false, reason: 'invalid_otp' };
                        }
                    } catch (error) {
                        console.error("Error verifying OTP:", error);
                        return { verified: false, reason: 'error' };
                    }
                }
            }

            // Add this helper function for local storage deletion
            function deleteUserByEmail(email) {
                const users = getUsers();
                const lowerEmail = email.toLowerCase();
                let userKey = null;

                for (const key in users) {
                    const user = users[key];
                    if (user.email.toLowerCase() === lowerEmail) {
                        userKey = key;
                        break;
                    }
                }

                if (userKey) {
                    delete users[userKey];
                    localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(users));
                    return true;
                }

                return false;
            }

            // Add this function after setupInputAnimations() but before the handleLocalLogin function
            function setupFormSubmitOnEnter() {
                // Handle Enter key for main login form
                document.getElementById('login-username').addEventListener('keyup', function (event) {
                    if (event.key === 'Enter') {
                        document.getElementById('login-password').focus();
                    }
                });

                document.getElementById('login-password').addEventListener('keyup', function (event) {
                    if (event.key === 'Enter') {
                        document.getElementById('login-btn').click();
                    }
                });

                // Handle Enter key for signup form
                const signupFields = ['signup-name', 'signup-username', 'signup-email', 'signup-password'];
                signupFields.forEach((id, index) => {
                    document.getElementById(id).addEventListener('keyup', function (event) {
                        if (event.key === 'Enter') {
                            if (index < signupFields.length - 1) {
                                // Move to next field if not the last one
                                document.getElementById(signupFields[index + 1]).focus();
                            } else {
                                // Submit the form if it's the last field
                                document.getElementById('signup-btn').click();
                            }
                        }
                    });
                });

                // Handle Enter key for forgot password popup
                document.getElementById('forgot-email').addEventListener('keyup', function (event) {
                    if (event.key === 'Enter') {
                        document.getElementById('forgot-submit-btn').click();
                    }
                });

                // Handle Enter key for delete account popup - first step
                document.getElementById('delete-email').addEventListener('keyup', function (event) {
                    if (event.key === 'Enter') {
                        document.getElementById('delete-verify-btn').click();
                    }
                });

                // Handle Enter key for delete account confirmation
                document.getElementById('delete-password').addEventListener('keyup', function (event) {
                    if (event.key === 'Enter') {
                        document.getElementById('delete-verify-btn').click();
                    }
                });
            }

            // Add a function to generate a local UID for fallback mode
            function generateLocalUserUid() {
                return 'local_' + Math.random().toString(36).substr(2, 9);
            }
        });
    </script>

    <!-- Forgot Password Modal -->
    <div class="modal-overlay" id="forgot-password-overlay">
        <div class="modal">
            <h3>Reset Password</h3>
            <div class="input-field">
                <input type="email" id="forgot-email" required>
                <label for="forgot-email">Email Address</label>
            </div>
            <div class="loading" id="forgot-loading"></div>
            <div class="feedback-message" id="forgot-error"></div>
            <div class="success-message" id="forgot-success"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="forgot-cancel-btn">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="forgot-submit-btn">Send Reset Link</button>
            </div>
        </div>
    </div>

    <!-- Delete Account Modal -->
    <div class="modal-overlay" id="delete-account-overlay">
        <div class="modal">
            <h3>Delete Account</h3>
            <p>To delete your account, please verify your email address.</p>
            <div class="input-field">
                <input type="email" id="delete-email" required>
                <label for="delete-email">Email Address</label>
            </div>
            <div id="confirm-delete-section" style="display: none;">
                <p style="color: #dc3545; margin-bottom: 15px;">Are you sure you want to delete your account? This
                    action cannot be undone.</p>
                <div class="input-field">
                    <input type="password" id="delete-password" required>
                    <label for="delete-password">Enter your password to confirm</label>
                </div>
            </div>
            <div class="loading" id="delete-loading"></div>
            <div class="feedback-message" id="delete-error"></div>
            <div class="success-message" id="delete-success"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="delete-cancel-btn">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="delete-verify-btn">Verify</button>
            </div>
        </div>
    </div>

    <!-- Footer Section -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-logo">
                <span class="fire">Fire</span><span class="fly">Fly</span><span class="nox">-NOX</span>
            </div>
            <div class="footer-links">
                <h6>Developed by :<a href="#"> Divyanshu Gupta</a></h6>
            </div>
            <div class="footer-social">
                <a href="#" class="social-icon"><i class="fab fa-facebook-f"></i></a>
                <a href="#" class="social-icon"><i class="fab fa-twitter"></i></a>
                <a href="#" class="social-icon"><i class="fab fa-instagram"></i></a>
                <a href="#" class="social-icon"><i class="fab fa-linkedin-in"></i></a>
            </div>
            <div class="footer-copyright">
                FireFly-NOX | &copy; All Rights Reserved 2025.
            </div>
        </div>
    </footer>

    <!-- Add styling to hide the Connection ID field from users -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Get the connection ID field container and hide it
            const connectionIdField = document.getElementById('signup-connectionid');
            const connectionIdContainer = connectionIdField ? connectionIdField.closest('.input-field') : null;

            if (connectionIdContainer) {
                connectionIdContainer.style.display = 'none';
            }
        });
    </script>

    <!-- Add this script to generate a random connection ID before form submission -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Generate random connection ID function
            function generateRandomConnectionId() {
                // Create a random string using timestamp and random characters
                const timestamp = new Date().getTime().toString(36);
                const randomStr = Math.random().toString(36).substr(2, 8);
                return `conn_${timestamp}_${randomStr}`;
            }

            // Get the connection ID field and hide its container
            const connectionIdField = document.getElementById('signup-connectionid');
            const connectionIdContainer = connectionIdField ? connectionIdField.closest('.input-field') : null;

            if (connectionIdContainer) {
                connectionIdContainer.style.display = 'none';
            }

            // Set a random value in the connection ID field initially
            if (connectionIdField) {
                connectionIdField.value = generateRandomConnectionId();
            }

            // Add event listener to the signup button to refresh the random ID on click
            const signupBtn = document.getElementById('signup-btn');
            if (signupBtn) {
                signupBtn.addEventListener('click', function (e) {
                    // Update the connection ID with a new random value before form submission
                    if (connectionIdField) {
                        connectionIdField.value = generateRandomConnectionId();
                        console.log('Generated random connection ID:', connectionIdField.value);
                    }
                }, { capture: true }); // Use capture phase to ensure this runs before form submission
            }
        });
    </script>
</body>

</html>